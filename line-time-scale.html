<!doctype html>
<html>

<head>
	<title>Line Chart</title>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.3/Chart.bundle.js"></script>
	<style>
    canvas {
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }
	</style>
	<style>#canvas { background-color: rgba(0, 0, 0, 0.9); }</style> <!--so dark-->
	<meta charset="UTF-8">
</head>

<body bgcolor=#000000 > <!--darkness-->
<input id="id_time" list="people_list" autofocus maxlength="10000"><button onclick="weekly()">Check</button>
<datalist id="people_list">
##people_list##
</datalist>
	<div style="width:95%;">
		<canvas id="canvas"></canvas>
	</div>
	
	<font color="white">
	Odebrane:<input type="checkbox" id="display_received" checked onclick="display_received()">
	Wysłane:<input type="checkbox" id="display_sent" checked onclick="display_sent()">
	
	<div id="messages_per_conversation">Loading...</div>
	</font>

	
	<script>
	Chart.defaults.global.defaultFontColor="#999"
	Chart.defaults.scale.gridLines.color="rgba(250, 250, 250, 0.15)"
		var timeFormat = 'MM/DD/YYYY HH:mm';

		var received_cfg={
					borderColor: "rgba(255, 0, 0, 0.6)",
					backgroundColor: "rgba(180, 0, 0, 0)",
					pointBorderColor: "rgba(255, 200, 180, 0.6)",
					pointBackgroundColor: "rgba(255, 200, 180, 0.6)",
					data: ##dataR##
		}
		
		var sent_cfg={
					borderColor: "rgba(0, 255, 0, 0.6)",
					backgroundColor: "rgba(190, 255, 70, 0)",
					pointBorderColor: "rgba(150, 255, 200, 0.6)",
					pointBackgroundColor: "rgba(150, 255, 200, 0.6)",
					data: ##dataS##
		}
		
		
		function newDate(days) {
			return moment().add(days, 'd').toDate();
		}

		var config = {
			type: 'line',
			data: {
				labels: ##dates##, // Date Objects
				datasets: [
				{
					label: "Odebrane", //received messages
					borderColor: received_cfg.borderColor,
					backgroundColor: received_cfg.backgroundColor,
					pointBorderColor: received_cfg.pointBorderColor,
					pointBackgroundColor: received_cfg.pointBackgroundColor,
					pointBorderWidth: 1,
					data: received_cfg.data
				},
				{
					label: "Wysłane", //sent messages
					borderColor: sent_cfg.borderColor,
					backgroundColor: sent_cfg.backgroundColor,
					pointBorderColor: sent_cfg.pointBorderColor,
					pointBackgroundColor: sent_cfg.pointBackgroundColor,
					pointBorderWidth: 1,
					data: sent_cfg.data
				},
				{
					label: "Łącznie", //sent+received
					borderColor: "rgba(0, 0, 255, 1)",
					backgroundColor: "rgba(0, 0, 175, 0.4)",
					pointBorderColor: "rgba(150, 220, 255, 1)",
					pointBackgroundColor: "rgba(150, 220, 255, 1)",
					pointBorderWidth: 1,
					data: ##data##
				}]
			},
			options: {
				responsive: true,
                title:{
                    display:true,
                    text:"Liczba wiadomości w dwutygodniowym okresie"
                },
				scales: {
					xAxes: [{
					
						type: "time",
						time: {
							format: timeFormat,
							tooltipFormat: 'll'
						},
						scaleLabel: {
							display: true,
							labelString: 'Data'
						}
					}, ],
					yAxes: [{
						scaleLabel: {
							display: true,
							labelString: 'Liczba wiadomości' //amount of messages
						}
					}]
				},
			}
		};

		window.onload = function() {
			var ctx = document.getElementById("canvas").getContext("2d");
			window.myLine = new Chart(ctx, config);

		};
		
		
		function weekly()
		{
			window.location.href="http://localhost:8097/"+encodeURI(document.getElementById('id_time').value)
		}
		
		var transparent_c="rgba(0, 0, 0, 0)"
		
		function display_received()
		{
			if(!document.getElementById("display_received").checked)
			{
				config.data.datasets[0].borderColor=transparent_c
				config.data.datasets[0].backgroundColor=transparent_c
				config.data.datasets[0].pointBorderColor=transparent_c
				config.data.datasets[0].pointBackgroundColor=transparent_c
				window.myLine.update();
				setTimeout(function () {config.data.datasets[0].data=new Array(config.data.datasets[0].data.length); window.myLine.update();}, 100)
			}
			else
			{
				config.data.datasets[0].borderColor=received_cfg.borderColor
				config.data.datasets[0].backgroundColor=received_cfg.backgroundColor
				config.data.datasets[0].pointBorderColor=received_cfg.pointBorderColor
				config.data.datasets[0].pointBackgroundColor=received_cfg.pointBackgroundColor
				config.data.datasets[0].data=received_cfg.data;
				window.myLine.update();
			}
		}
		
		function display_sent()
		{
			if(!document.getElementById("display_sent").checked)
			{
				config.data.datasets[1].borderColor=transparent_c
				config.data.datasets[1].backgroundColor=transparent_c
				config.data.datasets[1].pointBorderColor=transparent_c
				config.data.datasets[1].pointBackgroundColor=transparent_c
				window.myLine.update();
				setTimeout(function () {config.data.datasets[1].data=new Array(config.data.datasets[1].data.length); window.myLine.update();}, 100)
			}
			else
			{
				config.data.datasets[1].borderColor=sent_cfg.borderColor
				config.data.datasets[1].backgroundColor=sent_cfg.backgroundColor
				config.data.datasets[1].pointBorderColor=sent_cfg.pointBorderColor
				config.data.datasets[1].pointBackgroundColor=sent_cfg.pointBackgroundColor
				config.data.datasets[1].data=sent_cfg.data;
				window.myLine.update();
			}
		}
	
	
	
	function messages_per_conversation() //function gets data from server and generate table.
	{
		var wyn='<table style="border-collapse:collapse; /*table-layout:fixed; width:810px;*/"><tr><th>Participants</th><th>Messages</th></tr>';
		xhr = new XMLHttpRequest();
		xhr.open('GET', '/messages_per_conversation');
		xhr.onload=function()
		{
			var tmp=JSON.parse(xhr.responseText);
			console.log("Got: "+tmp);
			for(i in tmp)
			{
				wyn+="<tr>"
				
				wyn+='<td style="word-wrap:break-word; max-width: 400px;">'+tmp[i].participants+"</td>"
				
				wyn+="<td>";
				
				wyn+=tmp[i].messages;
				
				wyn+="</td>"
				
				wyn+="</tr>"
			}
			wyn+="</table>"
			document.getElementById('messages_per_conversation').innerHTML=wyn;
		}
		xhr.send();
	}
	messages_per_conversation();
	</script>
</body>

</html>
