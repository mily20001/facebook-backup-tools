<html>
  <head>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
	<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.1.3/Chart.bundle.js"></script>
	<style>
		canvas {
				-moz-user-select: none;
				-webkit-user-select: none;
				-ms-user-select: none;
		}
		
		body {
    color: white;
		}
			
		#canvas {
			background-color: rgba(0, 0, 0, 0.9);
		}
			
		#global_stats{
		width:100%; 
		border-collapse:collapse; 
		}
		#global_stats td{ 
			padding:5px; border:#4433FF 1px solid;
		}
		/* Define the default color for all the table rows */
		#global_stats tr{
			background: #000000;
		}
		/* Define the hover highlight color for the table row */
		#global_stats tr:hover {
					background-color: #050F4D;
		}
		#global_stats th{
			padding:5px; border:#4433FF 1px solid;
		}

		#global_stats  tr:hover :nth-child(n+2):nth-child(-n+5){
			background-color: #023D02;
		}
		#global_stats  tr:hover :nth-child(n+10):nth-child(-n+13){
			background-color: #023D02;
		}
	</style>
	<meta charset="UTF-8">
  </head>
  
  
  <body bgcolor=#000000>
  
  <input id="participants" list="people_list" autofocus>
  <datalist id="people_list"></datalist>
	<button onclick="generate_chart()">Generate chart</button>
	<button onclick="generate_hour_chart()">Generate hour stats (global only)</button>

	<div style="width:98%;">
		<canvas id="canvas"></canvas>
	</div>
	
	<!--To be removed-->
	Odebrane:<input type="checkbox" id="display_received" checked onclick="display_received()">
	Wysłane:<input type="checkbox" id="display_sent" checked onclick="display_sent()">
	
	<div id="global_stats">Loading stats...</div>
	
	
	
  <script> /*Websocket & communication stuff*/
  
  var ws = new WebSocket('ws://127.0.0.1:8097', 'fb_stats');
  ws.addEventListener("message", function(e)
  {
		var msg = JSON.parse(e.data);
		console.log("Got data via websocket")
		console.log("data: ")
		console.log(msg);
		
		
		if(msg.type=="weekly_stats")
		{
			received_cfg.data=msg.dataR;
			sent_cfg.data=msg.dataS;
			time_line_chart_config.data.datasets[0].data=msg.dataR
			time_line_chart_config.data.datasets[1].data=msg.dataS
			time_line_chart_config.data.datasets[2].data=msg.dataB; /*FIXME hardcoded :( */
			time_line_chart_config.data.labels=msg.labels
			
			if(window.myLine.chart.config.type=="line") /*if other type, then regenerate chart*/
				window.myLine.update();
			else
			{
				window.myLine.destroy();
				var ctx=document.getElementById("canvas").getContext("2d");
				window.myLine=new Chart(ctx, time_line_chart_config);
			}
		}
		else if(msg.type=="people")
		{
			document.getElementById("people_list").innerHTML=msg.list
		}
		else if(msg.type=="hour_stats")
		{
			bar_chart_config.data.labels=msg.labels;
			bar_chart_config.data.datasets[0].data=msg.data
			
			if(window.myLine.chart.config.type=="bar") /*if other type, then regenerate chart*/
				window.myLine.update(); 
			else
			{
				window.myLine.destroy();
				var ctx=document.getElementById("canvas").getContext("2d");
				window.myLine=new Chart(ctx, bar_chart_config);
			}
		}
	});
	
	function send(message)
	{
		if(ws.readyState!=ws.OPEN)
		{
			console.log("Queing message.")
			setTimeout(send, 10, message);
		}
		else
		{
			console.log("Sending message: "+message)
			ws.send(message);
		}
	}
	
	
	function generate_chart()
	{
		var message={"type": "weekly_stats",
					"participants": document.getElementById('participants').value.split(", ")}
		send(JSON.stringify(message));
	}
	
	function generate_hour_chart()
	{
		send(JSON.stringify({type: "hour_stats"}))
	}
	
	send(JSON.stringify({"type": "people"}))
	
	</script>
	
	<script> /*Chart stuff*/
	
	Chart.defaults.global.defaultFontColor="#999"
	Chart.defaults.scale.gridLines.color="rgba(250, 250, 250, 0.15)"
	var timeFormat = 'MM/DD/YYYY HH:mm';
	
	var received_cfg={
				borderColor: "rgba(255, 0, 0, 0.6)",
				backgroundColor: "rgba(180, 0, 0, 0)",
				pointBorderColor: "rgba(255, 200, 180, 0.6)",
				pointBackgroundColor: "rgba(255, 200, 180, 0.6)",
				data: []
	}
	
	var sent_cfg={
				borderColor: "rgba(0, 255, 0, 0.6)",
				backgroundColor: "rgba(190, 255, 70, 0)",
				pointBorderColor: "rgba(150, 255, 200, 0.6)",
				pointBackgroundColor: "rgba(150, 255, 200, 0.6)",
				data: []
	}
	
	var time_line_chart_config={
		type: 'line',
		data: {
			labels: [0, Date.now()], // Date Objects
			datasets: [
			{
				label: "Odebrane", //received messages
				borderColor: received_cfg.borderColor,
				backgroundColor: received_cfg.backgroundColor,
				pointBorderColor: received_cfg.pointBorderColor,
				pointBackgroundColor: received_cfg.pointBackgroundColor,
				pointBorderWidth: 1,
				data: received_cfg.data
			},
			{
				label: "Wysłane", //sent messages
				borderColor: sent_cfg.borderColor,
				backgroundColor: sent_cfg.backgroundColor,
				pointBorderColor: sent_cfg.pointBorderColor,
				pointBackgroundColor: sent_cfg.pointBackgroundColor,
				pointBorderWidth: 1,
				data: sent_cfg.data
			},
			{
				label: "Łącznie", //sent+received
				borderColor: "rgba(0, 0, 255, 1)",
				backgroundColor: "rgba(0, 0, 175, 0.4)",
				pointBorderColor: "rgba(150, 220, 255, 1)",
				pointBackgroundColor: "rgba(150, 220, 255, 1)",
				pointBorderWidth: 1,
				data: []
			}]
		},
		options: {
			responsive: true,
							title:{
									display:true,
									text:"Liczba wiadomości w dwutygodniowym okresie"
							},
			scales: {
				xAxes: [{
				
					type: "time",
					time: {
						format: timeFormat,
						tooltipFormat: 'll'
					},
					scaleLabel: {
						display: true,
						labelString: 'Data'
					}
				}, ],
				yAxes: [{
					scaleLabel: {
						display: true,
						labelString: 'Liczba wiadomości' //amount of messages
					}
				}]
			},
		}
	}
	
	
	var bar_chart_config={
		type: 'bar',
		data: {
			labels: [0, Date.now()], // Date Objects
			datasets: [{
				label: "Łącznie", //sent+received
				backgroundColor: "rgba(0, 0, 175, 0.4)",
				borderColor: "rgb(0, 0, 255)",
				data: []
			}]
		},
		options: {
				elements: {
					rectangle: {
						borderWidth: 2,
						borderColor: "rgb(0, 0, 255)",
						borderSkipped: 'bottom'
					}
				},
				responsive: true,
				legend: {
					position: 'top',
				},
				title: {
					display: true,
					text: 'Hour Stats'
				}
			}
	}
	
	
	window.onload = function() {
		var ctx = document.getElementById("canvas").getContext("2d");
		window.myLine = new Chart(ctx, time_line_chart_config);

	};
	
	
	var transparent_c="rgba(0, 0, 0, 0)"
	
	function display_received()
	{
		if(!document.getElementById("display_received").checked)
		{
			chart_config.data.datasets[0].borderColor=transparent_c
			chart_config.data.datasets[0].backgroundColor=transparent_c
			chart_config.data.datasets[0].pointBorderColor=transparent_c
			chart_config.data.datasets[0].pointBackgroundColor=transparent_c
			window.myLine.update();
			setTimeout(function () {chart_config.data.datasets[0].data=new Array(chart_config.data.datasets[0].data.length); window.myLine.update();}, 100)
		}
		else
		{
			chart_config.data.datasets[0].borderColor=received_cfg.borderColor
			chart_config.data.datasets[0].backgroundColor=received_cfg.backgroundColor
			chart_config.data.datasets[0].pointBorderColor=received_cfg.pointBorderColor
			chart_config.data.datasets[0].pointBackgroundColor=received_cfg.pointBackgroundColor
			chart_config.data.datasets[0].data=received_cfg.data;
			window.myLine.update();
		}
	}
	
	function display_sent()
	{
		if(!document.getElementById("display_sent").checked)
		{
			chart_config.data.datasets[1].borderColor=transparent_c
			chart_config.data.datasets[1].backgroundColor=transparent_c
			chart_config.data.datasets[1].pointBorderColor=transparent_c
			chart_config.data.datasets[1].pointBackgroundColor=transparent_c
			window.myLine.update();
			setTimeout(function () {chart_config.data.datasets[1].data=new Array(chart_config.data.datasets[1].data.length); window.myLine.update();}, 100)
		}
		else
		{
			chart_config.data.datasets[1].borderColor=sent_cfg.borderColor
			chart_config.data.datasets[1].backgroundColor=sent_cfg.backgroundColor
			chart_config.data.datasets[1].pointBorderColor=sent_cfg.pointBorderColor
			chart_config.data.datasets[1].pointBackgroundColor=sent_cfg.pointBackgroundColor
			chart_config.data.datasets[1].data=sent_cfg.data;
			window.myLine.update();
		}
	}
	</script>
	
	<script> /*Global stats*/
	
	function global_stats() //function gets data from server and generate table.
	{
		var wyn='<table id="global_stats" style="border-collapse:collapse;"><tr><th>Participants</th><th>Messages</th><th>Sent msg</th><th>Recv msg</th><th>S/R%</th><th>Words</th><th>Sent words</th><th>Recv words</th><th>S/R%</th><th>Chars</th><th>Sent chars</th><th>Recv chars</th><th>S/R%</th></tr>';
		xhr = new XMLHttpRequest();
		xhr.open('GET', '/messages_per_conversation');
		xhr.onload=function()
		{
			var tmp=JSON.parse(xhr.responseText);
			console.log("Got: "+tmp);
			
			for(i in tmp)
			{
				var sent_messages_percent=(tmp[i].sent_messages*100/tmp[i].messages).toFixed(1);
				var sent_words_percent=(tmp[i].sent_words*100/(tmp[i].sent_words+tmp[i].received_words)).toFixed(1)
				var sent_chars_percent=(tmp[i].sent_chars*100/(tmp[i].sent_chars+tmp[i].received_chars)).toFixed(1)
			
				wyn+="<tr>"
				
				wyn+='<td style="word-wrap:break-word; max-width: 300px;">'+tmp[i].participants+"</td>"
				
				wyn+="<td>";
				
				wyn+=tmp[i].messages;
				
				wyn+="</td>"
				
				wyn+="<td>";
				
				wyn+=tmp[i].sent_messages;
				
				wyn+="</td>"
				
				wyn+="<td>";
				
				wyn+=tmp[i].received_messages;
				
				wyn+="</td>"
				
				wyn+="<td>";
				
				wyn+=sent_messages_percent+"/"+(100-sent_messages_percent).toFixed(1)+" "+((sent_messages_percent<48)?("↓"):((sent_messages_percent>52)?("↑"):("-")))
				
				wyn+="</td>"
				
				wyn+="<td>";
				
				wyn+=tmp[i].sent_words+tmp[i].received_words;
				
				wyn+="</td>"
				
				wyn+="<td>";
				
				wyn+=tmp[i].sent_words;
				
				wyn+="</td>"
				
				wyn+="<td>";
				
				wyn+=tmp[i].received_words;
				
				wyn+="</td>"
				
				wyn+="<td>";
				
				wyn+=sent_words_percent+"/"+(100-sent_words_percent).toFixed(1)+" "+((sent_words_percent<48)?("↓"):((sent_words_percent>52)?("↑"):("-")))
				
				wyn+="</td>"
				
				wyn+="<td>";
				
				wyn+=tmp[i].sent_chars+tmp[i].received_chars;
				
				wyn+="</td>"
				
				wyn+="<td>";
				
				wyn+=tmp[i].sent_chars;
				
				wyn+="</td>"
				
				wyn+="<td>";
				
				wyn+=tmp[i].received_chars;
				
				wyn+="</td>"
				
				wyn+="<td>";
				
				wyn+=sent_chars_percent+"/"+(100-sent_chars_percent).toFixed(1)+" "+((sent_chars_percent<48)?("↓"):((sent_chars_percent>52)?("↑"):("-")))
				
				wyn+="</td>"
				
				wyn+="</tr>"
			}
			wyn+="</table>"
			document.getElementById('global_stats').innerHTML=wyn;
		}
		xhr.send();
	}
	global_stats();
	
	</script>
	
</body>
</html>
